{% extends "base.html" %}

{% block title %}Job Search Results - {{ job_title }} in {{ location }}{% endblock %}

{% block content %}
<!-- Search Form (Compact) -->
<div class="form-container">
    <form method="POST" action="{{ url_for('search_jobs') }}" class="search-form">
        <div class="form-group">
            <input type="text" name="job_title" value="{{ job_title }}" 
                   class="form-input" placeholder="Job title" required>
        </div>
        <div class="form-group">
            <input type="text" name="location" value="{{ location }}" 
                   class="form-input" placeholder="Location" required>
        </div>
        <div class="form-group">
            <button type="submit" class="form-button">Search</button>
        </div>
    </form>
</div>

<!-- AI Market Summary -->
{% if ai_summary and not ai_summary.error %}
<div class="ai-summary">
    <h2>AI Market Insights</h2>
    <p>Powered by GPT-4o • {{ ai_summary.job_count }} jobs analysed</p>
    <div class="ai-content">
        {{ ai_summary.summary }}
    </div>
</div>
{% elif ai_summary and ai_summary.error %}
<div class="error-message">
    <p>AI summary temporarily unavailable. Job results are still available below.</p>
</div>
{% endif %}

<!-- Search Results Header -->
<div class="results-header">
    <div>
        <h1>{{ search_results.count or 0 }} Jobs Found</h1>
        <p>{{ job_title }} positions in {{ location }}</p>
    </div>
    
    {% if current_user.is_authenticated %}
    <div class="results-save-tip">
        Click the bookmark icon to save jobs
    </div>
    {% endif %}
</div>

<!-- Error Message -->
{% if search_results.error %}
<div class="error-message">
    <p>{{ search_results.error }}</p>
</div>
{% endif %}

<!-- Job Results -->
{% if search_results.results %}
<div>
    {% for job in search_results.results %}
    <div class="card job-card">
        <div class="job-header">
            <div style="flex: 1;">
                <div class="job-title-row">
                    <h3 class="job-title">
                        <a href="{{ job.redirect_url }}" target="_blank">{{ job.title }}</a>
                    </h3>
                    {% if current_user.is_authenticated %}
                    <button class="save-job-btn" 
                            data-job-id="{{ job.id }}"
                            data-job-title="{{ job.title }}"
                            data-company="{{ job.company }}"
                            data-location="{{ job.location }}"
                            data-job-url="{{ job.redirect_url }}"
                            data-description="{{ job.description|truncate(200) }}"
                            data-salary-min="{{ job.salary_min or '' }}"
                            data-salary-max="{{ job.salary_max or '' }}">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                
                <div class="job-meta">
                    <span>
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        {{ job.company }}
                    </span>
                    <span>
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        {{ job.location }}
                    </span>
                    {% if job.created %}
                    <span>
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        {{ job.created[:10] }}
                    </span>
                    {% endif %}
                </div>
                
                {% if job.salary_min or job.salary_max %}
                <div class="salary-badge">
                    {% if job.salary_min and job.salary_max %}
                        £{{ "{:,.0f}".format(job.salary_min) }} - £{{ "{:,.0f}".format(job.salary_max) }}
                    {% elif job.salary_min %}
                        £{{ "{:,.0f}".format(job.salary_min) }}+
                    {% elif job.salary_max %}
                        Up to £{{ "{:,.0f}".format(job.salary_max) }}
                    {% endif %}
                </div>
                {% endif %}
                
                {% if job.description %}
                <p class="job-description">
                    {{ job.description[:300] }}{% if job.description|length > 300 %}...{% endif %}
                </p>
                {% endif %}
                
                <div class="job-actions">
                    <a href="{{ job.redirect_url }}" target="_blank" class="btn btn-primary">
                        View Job
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-left: 0.25rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                    {% if current_user.is_authenticated %}
                    <span class="job-save-tip">Click bookmark to save</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if search_results.total_pages and search_results.total_pages > 1 %}
<div class="pagination">
    {% if search_results.page > 1 %}
    <a href="{{ url_for('search_jobs', job_title=job_title, location=location, page=search_results.page-1) }}">
        Previous
    </a>
    {% endif %}
    
    <span class="current">
        Page {{ search_results.page }} of {{ search_results.total_pages }}
    </span>
    
    {% if search_results.page < search_results.total_pages %}
    <a href="{{ url_for('search_jobs', job_title=job_title, location=location, page=search_results.page+1) }}">
        Next
    </a>
    {% endif %}
</div>
{% endif %}

{% else %}
<!-- No Results -->
<div class="no-results">
    <div class="no-results-icon">
        <svg width="48" height="48" fill="none" stroke="#9ca3af" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.47-.881-6.08-2.33"></path>
        </svg>
    </div>
    <h3>No jobs found</h3>
    <p>Try adjusting your search terms or location</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary">New Search</a>
</div>
{% endif %}

<!-- Save Job JavaScript -->
{% if current_user.is_authenticated %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to save job buttons
    document.querySelectorAll('.save-job-btn').forEach(button => {
        button.addEventListener('click', function() {
            const jobData = {
                job_id: this.dataset.jobId,
                job_title: this.dataset.jobTitle,
                company: this.dataset.company,
                location: this.dataset.location,
                job_url: this.dataset.jobUrl,
                description: this.dataset.description,
                salary_min: this.dataset.salaryMin ? parseFloat(this.dataset.salaryMin) : null,
                salary_max: this.dataset.salaryMax ? parseFloat(this.dataset.salaryMax) : null
            };
            
            saveJob(jobData, this);
        });
    });
});

function saveJob(jobData, buttonElement) {
    fetch('/save_job', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(jobData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Change button appearance to show saved
            buttonElement.innerHTML = '<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>';
            buttonElement.onclick = () => unsaveJob(jobData.job_id, buttonElement);
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save job');
    });
}

function unsaveJob(jobId, buttonElement) {
    fetch('/unsave_job', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({job_id: jobId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Change button appearance back
            buttonElement.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>';
            // Re-add the original click handler
            buttonElement.addEventListener('click', function() {
                const jobData = {
                    job_id: this.dataset.jobId,
                    job_title: this.dataset.jobTitle,
                    company: this.dataset.company,
                    location: this.dataset.location,
                    job_url: this.dataset.jobUrl,
                    description: this.dataset.description,
                    salary_min: this.dataset.salaryMin ? parseFloat(this.dataset.salaryMin) : null,
                    salary_max: this.dataset.salaryMax ? parseFloat(this.dataset.salaryMax) : null
                };
                saveJob(jobData, this);
            });
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove job');
    });
}
</script>
{% endif %}
{% endblock %}